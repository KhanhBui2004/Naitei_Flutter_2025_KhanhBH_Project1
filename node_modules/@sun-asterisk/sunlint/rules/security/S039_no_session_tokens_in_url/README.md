# S039 - Do Not Pass Session Tokens via URL Parameters

## Overview

Rule S039 detects when session tokens, authentication tokens, JWT tokens, or other sensitive authentication data are passed as URL parameters instead of secure headers or request body. URL parameters are logged in web server logs, browser history, and can be exposed in referrer headers.

## Framework Support

This rule supports multiple web frameworks:

- **Express.js**: Parameter access via `req.query`, `req.params`
- **Next.js**: URL parameter access via `searchParams.get()`, `new URL().searchParams`
- **NestJS**: Parameter decorators `@Query()`, `@Param()`
- **Nuxt.js**: Server route parameter handling
- **Client-side**: Browser URL parameter access via `location.search`, `URLSearchParams`

## Security Impact

Passing session tokens via URL parameters creates several security vulnerabilities:

1. **Web Server Logs**: URL parameters are logged in web server access logs
2. **Browser History**: URLs with parameters are stored in browser history
3. **Referrer Headers**: URLs may be exposed when navigating to external sites
4. **Shared URLs**: Users may inadvertently share URLs containing tokens
5. **Cache Poisoning**: URLs with tokens may be cached by proxies or CDNs
6. **Analytics Tracking**: URL parameters are often sent to analytics services

## Rule Details

### Detected Token Parameter Names

The rule detects the following session token parameter patterns:

| Parameter Name | Variants                                            |
| -------------- | --------------------------------------------------- |
| Session ID     | `sessionId`, `session_id`, `session-id`             |
| Session Token  | `sessionToken`, `session_token`, `session-token`    |
| Auth Token     | `authToken`, `auth_token`, `auth-token`             |
| Authorization  | `authorization`, `bearer`                           |
| JWT            | `jwt`, `jwtToken`, `jwt_token`, `jwt-token`         |
| Access Token   | `accessToken`, `access_token`, `access-token`       |
| Refresh Token  | `refreshToken`, `refresh_token`, `refresh-token`    |
| API Key        | `apiKey`, `api_key`, `api-key`                      |
| CSRF Token     | `csrfToken`, `csrf_token`, `csrf-token`             |
| XSRF Token     | `xsrfToken`, `xsrf_token`, `xsrf-token`             |
| Generic Token  | `token`, `apiToken`, `api_token`, `api-token`       |
| Session Key    | `sid`, `sessionkey`, `session_key`, `session-key`   |
| User Token     | `userToken`, `user_token`, `user-token`             |
| Auth Key       | `authKey`, `auth_key`, `auth-key`                   |
| Security Token | `securityToken`, `security_token`, `security-token` |

### Detected Access Patterns

✅ **Secure Alternatives:**

```typescript
// Use Authorization header
app.get("/api/user", (req, res) => {
  const token = req.headers.authorization?.replace("Bearer ", "");
  // Process token securely
});

// Use request body for POST requests
app.post("/api/authenticate", (req, res) => {
  const { sessionToken } = req.body;
  // Process token securely
});

// Use secure cookies
app.get("/api/profile", (req, res) => {
  const sessionId = req.cookies.sessionId;
  // Process session ID securely
});
```

❌ **Violation Examples:**

```typescript
// Express.js violations
app.get('/api/user', (req, res) => {
  const sessionToken = req.query.sessionToken; // ❌ Token in URL
  const authKey = req.params.authKey; // ❌ Token in URL
});

// Object destructuring violations
app.get('/api/data', (req, res) => {
  const { jwt, apiKey } = req.query; // ❌ Multiple tokens in URL
});

// NestJS violations
@Get('user')
getUserData(@Query('sessionToken') token: string) { // ❌ Token in URL
  // ...
}

@Get('profile/:authToken')
getProfile(@Param('authToken') token: string) { // ❌ Token in URL path
  // ...
}

// Next.js violations
export async function GET(request: Request) {
  const url = new URL(request.url);
  const jwt = url.searchParams.get('jwt'); // ❌ Token in URL
  // ...
}

// Client-side violations
const params = new URLSearchParams(location.search);
const sessionId = params.get('sessionId'); // ❌ Token in URL
```

### Framework-Specific Detection

#### Express.js

- `req.query.tokenName`
- `req.params.tokenName`
- Object destructuring: `{ tokenName } = req.query`

#### NestJS

- `@Query('tokenName')`
- `@Param('tokenName')`

#### Next.js

- `searchParams.get('tokenName')`
- `new URL().searchParams.get('tokenName')`
- `URLSearchParams().get('tokenName')`

#### Client-side JavaScript

- `location.search` with subsequent parameter parsing
- `URLSearchParams(location.search).get('tokenName')`
- `window.location.search` parameter access

## Best Practices

### ✅ Secure Token Transmission

1. **Authorization Headers**:

   ```typescript
   // Send token in Authorization header
   fetch("/api/data", {
     headers: {
       Authorization: `Bearer ${token}`,
     },
   });
   ```

2. **Request Body**:

   ```typescript
   // Send token in request body for POST requests
   fetch("/api/authenticate", {
     method: "POST",
     headers: { "Content-Type": "application/json" },
     body: JSON.stringify({ sessionToken: token }),
   });
   ```

3. **Secure Cookies**:
   ```typescript
   // Store session in secure, HTTP-only cookies
   res.cookie("sessionId", sessionId, {
     httpOnly: true,
     secure: true,
     sameSite: "strict",
   });
   ```

### ❌ Avoid These Patterns

1. **URL Query Parameters**: Never pass tokens as `?token=abc123`
2. **URL Path Parameters**: Never embed tokens in URL paths `/api/user/abc123`
3. **Fragment Identifiers**: Avoid `#token=abc123` (though less logged)
4. **Form GET Methods**: Don't use GET forms for token submission

## Configuration

The rule can be configured in `config.json`:

```json
{
  "validation": {
    "sessionTokenParams": ["custom-token", "my-auth-key"],
    "frameworks": ["express", "nestjs", "nextjs"]
  }
}
```

## Related Security Rules

- **S027**: No hardcoded secrets - Prevents tokens in source code
- **S031**: Secure session cookies - Ensures proper cookie security
- **S016**: No sensitive data in query strings - Broader sensitive data protection
