# S037 - Configure Comprehensive Cache Headers to Prevent Sensitive Data Leakage

## Overview

Rule S037 ensures that sensitive HTTP responses explicitly disable caching using a complete set of anti-caching headers:

- `Cache-Control: no-store, no-cache, must-revalidate`
- `Pragma: no-cache`
- `Expires: 0`

These prevent browsers and intermediate proxies from persisting sensitive content (e.g., authenticated pages, profile data, tokens) in cache storage where it could later be exposed.

## Framework Support

This rule supports multiple web frameworks:

- **Express.js**: Route handlers using `app.get()`, `router.post()`, etc.
- **Next.js**: API routes (`export default function handler`) and App Router (`export async function GET`)
- **NestJS**: Controller methods with decorators (`@Get()`, `@Post()`, etc.)
- **Nuxt.js**: Server routes (`export default defineEventHandler`)

## Security Impact

Without proper cache headers, authenticated or confidential data may remain in browser cache or be served to other users (in shared environments, kiosk systems, or via back/forward navigation). Attackers may retrieve cached responses, exposing session data or personal information.

## Rule Details

### Required Header Set

All of the following must be present for sensitive responses:

| Header        | Required Value / Directives                                                 |
| ------------- | --------------------------------------------------------------------------- |
| Cache-Control | `no-store, no-cache, must-revalidate` (order flexible, directives required) |
| Pragma        | `no-cache`                                                                  |
| Expires       | `0` (or a past date)                                                        |

### Sensitive Response Indicators (heuristic)

The rule assumes a response is sensitive when code references identifiers like: `session`, `auth`, `token`, `jwt`, `csrf`, `user`, `profile`, `payment`, `account`.

### Detected Patterns

✅ **Compliant Examples:**

```typescript
res.setHeader("Cache-Control", "no-store, no-cache, must-revalidate");
res.setHeader("Pragma", "no-cache");
res.setHeader("Expires", "0");
res.json({ user: profile });
```

```typescript
response.set({
  "Cache-Control": "no-store, no-cache, must-revalidate",
  Pragma: "no-cache",
  Expires: "0",
});
```

❌ **Violation Examples:**

```typescript
// Missing Cache-Control directives
res.setHeader("Cache-Control", "no-cache");
res.setHeader("Pragma", "no-cache");
res.setHeader("Expires", "0");
```

```typescript
// Missing Pragma and Expires
res.setHeader("Cache-Control", "no-store, no-cache, must-revalidate");
```

```typescript
// Missing all anti-cache headers
res.json({ auth: token, profile });
```

### Partial Cache-Control Values

The rule flags missing directives individually when `Cache-Control` is present but incomplete.

| Example Value                         | Result                                    |
| ------------------------------------- | ----------------------------------------- |
| `no-cache`                            | ❌ Missing: `no-store`, `must-revalidate` |
| `no-store, no-cache`                  | ❌ Missing: `must-revalidate`             |
| `no-store, no-cache, must-revalidate` | ✅ Valid                                  |

## Analysis Approach

### Symbol-Based (Primary)

Parses AST to collect header setting calls across a file, then evaluates completeness.

### Regex-Based (Fallback)

Scans for literal `setHeader`/`set` calls to approximate detection when semantic engine unavailable.

## Configuration

See `config.json` for adjustable keys:

- `validation.required` – mandatory headers & directives
- `validation.sensitiveIndicators` – triggers stricter enforcement when detected
- `patterns.include/exclude` – file targeting

## Best Practices

1. Always send complete anti-cache headers for authenticated pages.
2. Never rely only on `Pragma` or only `Cache-Control`.
3. Include `no-store` for maximum protection (prevents any storage).
4. Pair with other security headers (CSP, X-Content-Type-Options, etc.).
5. Re-check reverse proxy / CDN behavior (may override headers).

## Related Rules

- **S031**: Secure flag for cookies
- **S032**: HttpOnly flag for cookies
- **S033**: SameSite attribute
- **S034**: \_\_Host- prefix
- **S035**: Path attribute

## References

- MDN: HTTP Caching
- OWASP: Sensitive Data Exposure / Cryptographic Failures
- RFC 7234 - HTTP/1.1 Caching
