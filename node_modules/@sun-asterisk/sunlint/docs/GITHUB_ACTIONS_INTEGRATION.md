# GitHub Actions Integration

H∆∞·ªõng d·∫´n t√≠ch h·ª£p SunLint v·ªõi GitHub Actions ƒë·ªÉ t·ª± ƒë·ªông review Pull Requests.

## T√≠nh nƒÉng m·ªõi: Auto GitHub Annotation

SunLint gi·ªù ƒë√¢y c√≥ th·ªÉ t·ª± ƒë·ªông t·∫°o review comments tr√™n Pull Requests m√† **kh√¥ng c·∫ßn ch·ªâ ƒë·ªãnh `--output` v√† `--format=json`**.

### 3 Annotation Modes

`--github-annotate` h·ªó tr·ª£ 3 modes:

#### 1. **`annotate`** - Inline Comments Only
T·∫°o review comments tr·ª±c ti·∫øp tr√™n code (inline comments)
```bash
sunlint --all --input=src --github-annotate=annotate
```
- ‚úÖ Comment tr√™n t·ª´ng d√≤ng code c√≥ l·ªói
- ‚úÖ Duplicate detection
- ‚úÖ Batch processing (30 comments/review)

#### 2. **`summary`** - Summary Comment Only
T·∫°o 1 comment t·ªïng h·ª£p (nh∆∞ GitHub Actions summary)
```bash
sunlint --all --input=src --github-annotate=summary
```
- ‚úÖ Th·ªëng k√™ t·ªïng quan (errors, warnings, files)
- ‚úÖ Top 10 files c√≥ nhi·ªÅu l·ªói nh·∫•t
- ‚úÖ Auto update comment c≈© (kh√¥ng spam)

#### 3. **`all`** - Both (Default)
T·∫°o c·∫£ inline comments v√† summary comment
```bash
sunlint --all --input=src --github-annotate        # default
sunlint --all --input=src --github-annotate=all    # explicit
```
- ‚úÖ Full experience: inline + summary
- ‚úÖ Resilient: n·∫øu 1 task fail, task kia v·∫´n ch·∫°y

### C√°ch ho·∫°t ƒë·ªông

Khi s·ª≠ d·ª•ng flag `--github-annotate`:

1. ‚úÖ **T·ª± ƒë·ªông ph√°t hi·ªán PR event** - Ch·ªâ ch·∫°y khi event l√† `pull_request`
2. ‚úÖ **T·ª± ƒë·ªông t·∫°o JSON report** - Kh√¥ng c·∫ßn `--output` v√† `--format=json`
3. ‚úÖ **T·ª± ƒë·ªông cleanup** - X√≥a temp file sau khi annotate
4. ‚úÖ **Intelligent error handling** - B√°o l·ªói chi ti·∫øt v√† g·ª£i √Ω fix
5. ‚úÖ **Duplicate detection** - Tr√°nh spam comments tr√πng l·∫∑p
6. ‚úÖ **3 flexible modes** - Ch·ªçn mode ph√π h·ª£p v·ªõi workflow

## Quick Start

### Workflow ƒë∆°n gi·∫£n nh·∫•t

```yaml
name: SunLint PR Review
on:
  pull_request:
    branches: [main, develop]

jobs:
  sunlint:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install SunLint
        run: npm install -g sunlint

      - name: Run SunLint with Auto Annotation
        run: sunlint --all --input=src --github-annotate
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

**ƒê√≥ l√† t·∫•t c·∫£!** SunLint s·∫Ω t·ª± ƒë·ªông:
- Ph√¢n t√≠ch code
- T·∫°o JSON report (t·∫°m th·ªùi)
- Comment l√™n PR
- X√≥a file t·∫°m

## Advanced Usage

### 1. Analyze only changed files (Auto-detect PR)

**‚≠ê T√≠nh nƒÉng m·ªõi**: T·ª± ƒë·ªông ph√°t hi·ªán PR context, t·ª± ƒë·ªông fetch base branch, v√† s·ª≠ d·ª•ng merge-base ƒë·ªÉ diff ch√≠nh x√°c!

```yaml
steps:
  - name: Checkout code
    uses: actions/checkout@v4
    with:
      fetch-depth: 0  # Recommended: fetch full history for accurate diff

  - name: Run SunLint on Changed Files (Auto-detect)
    run: sunlint --all --changed-files --github-annotate
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

**‚ú® ƒê∆°n gi·∫£n nh·∫•t c√≥ th·ªÉ - kh√¥ng c·∫ßn config g√¨ th√™m!**

**C√°ch ho·∫°t ƒë·ªông**:

- ‚úÖ T·ª± ƒë·ªông detect GitHub Actions PR event (`GITHUB_EVENT_NAME=pull_request`)
- ‚úÖ T·ª± ƒë·ªông l·∫•y base branch t·ª´ `GITHUB_BASE_REF`
- ‚úÖ **T·ª± ƒë·ªông fetch base branch n·∫øu ch∆∞a c√≥** (kh√¥ng c·∫ßn th√™m step!)
- ‚úÖ Detect shallow clone v√† fetch th√™m history n·∫øu c·∫ßn
- ‚úÖ S·ª≠ d·ª•ng `git merge-base` ƒë·ªÉ t√¨m common ancestor
- ‚úÖ So s√°nh v·ªõi merge-base thay v√¨ HEAD ‚Üí L·∫•y ƒë√∫ng c√°c file thay ƒë·ªïi trong PR

**Kh√¥ng c·∫ßn:**

- ‚ùå Ch·ªâ ƒë·ªãnh `--diff-base`
- ‚ùå Th√™m step fetch base branch th·ªß c√¥ng
- ‚ùå Config ph·ª©c t·∫°p

**Fallback**: N·∫øu kh√¥ng ph√°t hi·ªán ƒë∆∞·ª£c PR context ho·∫∑c kh√¥ng fetch ƒë∆∞·ª£c base branch, s·∫Ω fallback v·ªÅ standard git diff logic

**‚ùì C√≥ c·∫ßn `fetch-depth: 0` kh√¥ng?**

**Kh√¥ng b·∫Øt bu·ªôc!** Nh∆∞ng **strongly recommended** v√¨ performance.

| Option | Performance | Checkout Time | Total Time | Accuracy |
|--------|-------------|---------------|------------|----------|
| **With `fetch-depth: 0`** ‚≠ê | Fast | +2-3s | **Fastest** | 100% |
| Without (shallow clone) | Slower | Fast | Slower | ~95% |

**V·ªõi `fetch-depth: 0` (Recommended):**

```yaml
- uses: actions/checkout@v4
  with:
    fetch-depth: 0  # One-time full fetch
```

- ‚úÖ **Fastest total time** - fetch once, use immediately
- ‚úÖ **100% accurate** - full history for merge-base
- ‚úÖ **Simpler** - no runtime fetch needed

**Kh√¥ng c√≥ `fetch-depth: 0` (V·∫´n work):**

```yaml
- uses: actions/checkout@v4  # Shallow clone (depth=1)
```

- ‚úÖ Fast checkout
- ‚ö†Ô∏è **Slower total time** - SunLint must fetch at runtime:
  - Detect shallow clone
  - `git fetch --deepen=50`
  - `git fetch origin/main --depth=50`
- ‚ö†Ô∏è May miss history for very large PRs

**Recommendation**: D√πng `fetch-depth: 0` tr·ª´ khi b·∫°n c√≥ l√Ω do ƒë·∫∑c bi·ªát (e.g., monorepo c·ª±c l·ªõn)

### 2. Save report file + annotate

```yaml
- name: Run SunLint
  run: sunlint --all --input=src --output=sunlint-report.json --github-annotate
  env:
    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

- name: Upload Report
  uses: actions/upload-artifact@v4
  if: always()
  with:
    name: sunlint-report
    path: sunlint-report.json
```

### 3. Run specific rules

```yaml
- name: Run Security Rules Only
  run: sunlint --security --input=src --github-annotate
  env:
    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

### 4. Multiple languages

```yaml
- name: Run SunLint on TypeScript and Kotlin
  run: sunlint --all --languages=typescript,kotlin --input=. --github-annotate
  env:
    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

### 5. V·ªõi verbose logging

```yaml
- name: Run SunLint (Verbose)
  run: sunlint --all --input=src --github-annotate --verbose
  env:
    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

## Complete Example Workflow

```yaml
name: Code Quality Check
on:
  pull_request:
    branches: [main, develop, 'release/**']
    paths:
      - '**.ts'
      - '**.tsx'
      - '**.js'
      - '**.jsx'
      - '**.kt'
      - '**.dart'

jobs:
  sunlint:
    name: SunLint Analysis
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # For git diff

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install SunLint
        run: npm install -g sunlint

      - name: Run SunLint on Changed Files
        id: sunlint
        continue-on-error: true  # Don't fail the workflow
        run: |
          sunlint --all \
            --changed-files \
            --diff-base=origin/${{ github.base_ref }} \
            --github-annotate \
            --output=sunlint-report.json \
            --verbose
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: sunlint-report-${{ github.event.pull_request.number }}
          path: sunlint-report.json
          retention-days: 30

      - name: Comment Summary
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            if (!fs.existsSync('sunlint-report.json')) return;

            const report = JSON.parse(fs.readFileSync('sunlint-report.json', 'utf8'));
            let violations = 0;
            let errors = 0;
            let warnings = 0;

            for (const file of report) {
              violations += file.messages.length;
              errors += file.errorCount;
              warnings += file.warningCount;
            }

            const body = `## SunLint Report

            üìä **Summary:**
            - Total violations: ${violations}
            - Errors: ${errors}
            - Warnings: ${warnings}

            ${violations === 0 ? '‚úÖ No issues found!' : '‚ö†Ô∏è Please check the PR comments for details.'}
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
```

## Environment Variables

SunLint t·ª± ƒë·ªông ƒë·ªçc c√°c bi·∫øn m√¥i tr∆∞·ªùng t·ª´ GitHub Actions:

| Variable | Description | Required |
|----------|-------------|----------|
| `GITHUB_TOKEN` | GitHub token for API access | ‚úÖ Yes |
| `GITHUB_REPOSITORY` | Repository (owner/repo) | Auto |
| `GITHUB_EVENT_NAME` | Event type (pull_request) | Auto |
| `GITHUB_EVENT_PATH` | Path to event payload | Auto |
| `RUNNER_TEMP` | Temp directory | Auto |

## Permissions Required

```yaml
permissions:
  contents: read         # To checkout code
  pull-requests: write   # To create review comments
```

## Troubleshooting

### 1. "GitHub annotation only works on pull_request events"

**Nguy√™n nh√¢n:** Workflow ch·∫°y tr√™n `push` event thay v√¨ `pull_request`

**Gi·∫£i ph√°p:**
```yaml
on:
  pull_request:  # Thay v√¨ push
    branches: [main]
```

### 2. "Missing GITHUB_TOKEN"

**Nguy√™n nh√¢n:** Thi·∫øu GITHUB_TOKEN trong env

**Gi·∫£i ph√°p:**
```yaml
env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

### 3. "Permission denied"

**Nguy√™n nh√¢n:** Token kh√¥ng c√≥ quy·ªÅn `pull-requests: write`

**Gi·∫£i ph√°p:**
```yaml
permissions:
  pull-requests: write
```

### 4. Annotations kh√¥ng hi·ªÉn th·ªã

**Nguy√™n nh√¢n:** File paths kh√¥ng ƒë√∫ng format

**Gi·∫£i ph√°p:** ƒê·∫£m b·∫£o paths l√† relative t·ª´ repo root:
```yaml
- uses: actions/checkout@v4  # Checkout ƒë√∫ng branch
```

### 5. Fork PRs kh√¥ng annotate ƒë∆∞·ª£c

**Nguy√™n nh√¢n:** `pull_request` event t·ª´ fork c√≥ quy·ªÅn h·∫°n ch·∫ø

**Gi·∫£i ph√°p:** D√πng `pull_request_target` (c·∫©n th·∫≠n v·ªÅ security!)
```yaml
on:
  pull_request_target:  # Cho fork PRs
```

## Best Practices

### 1. Fail on errors, warn on warnings

```yaml
- name: Run SunLint
  run: sunlint --all --input=src --github-annotate
  continue-on-error: false  # Fail if errors found
```

### 2. Cache SunLint installation

```yaml
- name: Cache SunLint
  uses: actions/cache@v3
  with:
    path: ~/.npm
    key: ${{ runner.os }}-sunlint-${{ hashFiles('**/package-lock.json') }}
```

### 3. Run only on specific files

```yaml
on:
  pull_request:
    paths:
      - 'src/**'
      - '!src/**/*.test.ts'
```

### 4. Matrix strategy for multiple projects

```yaml
jobs:
  sunlint:
    strategy:
      matrix:
        project: [frontend, backend, mobile]
    steps:
      - run: sunlint --all --input=${{ matrix.project }} --github-annotate
```

### 5. Skip on draft PRs

```yaml
jobs:
  sunlint:
    if: github.event.pull_request.draft == false
    steps:
      - run: sunlint --all --github-annotate
```

## Migration Guide

### From old style (with --output)

**Before:**
```yaml
- name: Run SunLint
  run: sunlint --all --input=src --output=report.json --format=json

- name: Annotate PR
  run: node annotate-script.js
  env:
    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

**After:**
```yaml
- name: Run SunLint with Auto Annotation
  run: sunlint --all --input=src --github-annotate
  env:
    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

## FAQ

**Q: C√≥ th·ªÉ d√πng cho push events kh√¥ng?**
A: Kh√¥ng. `--github-annotate` ch·ªâ ho·∫°t ƒë·ªông cho `pull_request` events. D√πng `--output` ƒë·ªÉ save report cho push events.

**Q: C√≥ b·ªã rate limit kh√¥ng?**
A: SunLint c√≥ retry mechanism v√† batch processing ƒë·ªÉ tr√°nh rate limit. Maximum 30 comments/review, t·ª± ƒë·ªông chia batches n·∫øu nhi·ªÅu h∆°n.

**Q: C√≥ th·ªÉ customize comment format kh√¥ng?**
A: Hi·ªán t·∫°i format l√† `[rule-id] message`. Customize format ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn.

**Q: C√≥ delete ƒë∆∞·ª£c comments c≈© kh√¥ng?**
A: SunLint c√≥ duplicate detection ƒë·ªÉ tr√°nh spam. Comments c≈© ƒë∆∞·ª£c gi·ªØ l·∫°i cho l·ªãch s·ª≠.

**Q: Performance v·ªõi large PRs?**
A: SunLint optimize cho large PRs v·ªõi:
- Batch processing
- Only comment on changed files
- Async operations
- Retry mechanism

## Examples Repository

Xem th√™m examples t·∫°i: [examples/github-actions/](../examples/github-actions/)

## Support

- Issues: [GitHub Issues](https://github.com/sun-asterisk/engineer-excellence/issues)
- Docs: [Documentation](../README.md)
- Community: [Discussions](https://github.com/sun-asterisk/engineer-excellence/discussions)
