# S030 - Disable Directory Browsing and Protect Sensitive Metadata Files

## Overview

This rule detects and prevents directory browsing vulnerabilities and exposure of sensitive metadata files that could lead to information disclosure.

## Security Concerns

### Directory Browsing

- **Information Disclosure**: Directory listing can reveal application structure, file names, and potentially sensitive information
- **Attack Surface**: Exposed directories provide attackers with reconnaissance information
- **Compliance**: Many security standards require disabling directory browsing

### Sensitive Metadata Files

- **Version Control**: `.git/`, `.svn/`, `.hg/` directories contain source code history
- **Configuration Files**: `.env`, `config.json`, `settings.yml` may contain secrets
- **Backup Files**: Database dumps, configuration backups can expose sensitive data
- **Development Files**: IDE settings, temporary files may contain sensitive information

## Detection Patterns

### ❌ Violations

```javascript
// Express.js - Directory browsing enabled
app.use(express.static("public", { index: false, dotfiles: "allow" }));
app.use("/files", serveIndex("uploads")); // Directory listing middleware

// Serving sensitive directories
app.use("/backup", express.static("./backups/"));
app.use("/.git", express.static("./.git/"));

// Missing protection for sensitive files
app.get("/.env", (req, res) => {
  res.sendFile(".env");
});

// Koa.js - Unsafe static serving
app.use(koaStatic("./public", { hidden: true }));

// Fastify - Directory browsing
fastify.register(require("@fastify/static"), {
  root: path.join(__dirname, "public"),
  list: true, // Enables directory listing
});
```

### ✅ Safe Alternatives

```javascript
// Express.js - Secure static file serving
app.use(
  express.static("public", {
    index: ["index.html", "index.htm"],
    dotfiles: "deny", // Block access to dotfiles
    redirect: false,
  })
);

// Explicit file serving with validation
app.get("/files/:filename", (req, res) => {
  const filename = path.basename(req.params.filename);
  const safePath = path.join(SAFE_DIRECTORY, filename);

  // Validate file exists and is safe
  if (fs.existsSync(safePath) && isAllowedFile(filename)) {
    res.sendFile(safePath);
  } else {
    res.status(404).send("File not found");
  }
});

// Koa.js - Secure configuration
app.use(
  koaStatic("./public", {
    hidden: false, // Don't serve hidden files
    index: "index.html",
    gzip: true,
  })
);

// Fastify - Disable directory listing
fastify.register(require("@fastify/static"), {
  root: path.join(__dirname, "public"),
  list: false, // Disable directory listing
  wildcard: false,
});

// Nginx-style protection in configuration
const protectedPaths = [".env", ".git", "config/", "backup/"];
app.use((req, res, next) => {
  const isProtected = protectedPaths.some((path) => req.url.includes(path));

  if (isProtected) {
    return res.status(403).send("Access denied");
  }

  next();
});
```

## Configuration Options

- **Severity**: Error (high security impact)
- **Categories**: Security, Information Disclosure
- **Frameworks**: Express.js, Koa.js, Fastify, Hapi.js
- **File Types**: JavaScript, TypeScript, Configuration files

## Implementation Notes

1. **Symbol-based Analysis**: Detects static file serving configurations and middleware usage
2. **Regex-based Fallback**: Identifies patterns in configuration files and string literals
3. **Framework Detection**: Supports multiple Node.js web frameworks
4. **Path Validation**: Checks for exposure of sensitive directories and files

## Related Security Rules

- S027: No hardcoded secrets
- S038: No version headers
- S055: Content type validation

## References

- [OWASP: Information Exposure](https://owasp.org/www-community/vulnerabilities/Information_exposure)
- [CWE-548: Exposure of Information Through Directory Listing](https://cwe.mitre.org/data/definitions/548.html)
- [Express.js Security Best Practices](https://expressjs.com/en/advanced/best-practice-security.html)
