# S028 - Limit Upload File Size and Number of Files Per User

## üìã T·ªïng quan

**Rule ID:** S028  
**M·ª©c ƒë·ªô:** Medium (‚ö†Ô∏è)  
**Danh m·ª•c:** Security  
**OWASP:** A04:2021 - Insecure Design  
**CWE:** CWE-400 - Uncontrolled Resource Consumption

### M·ª•c ƒë√≠ch

NgƒÉn ch·∫∑n c√°c cu·ªôc t·∫•n c√¥ng **Denial of Service (DoS)** v√† l·∫°m d·ª•ng t√†i nguy√™n b·∫±ng c√°ch ƒë·∫£m b·∫£o r·∫±ng m·ªçi file upload endpoint ƒë·ªÅu c√≥ gi·ªõi h·∫°n:

- **K√≠ch th∆∞·ªõc file** (file size limit)
- **S·ªë l∆∞·ª£ng file** (file count limit)
- **T·ªïng k√≠ch th∆∞·ªõc request** (request size limit)

### T·∫°i sao quan tr·ªçng?

1. **NgƒÉn ch·∫∑n DoS attacks**: Attacker c√≥ th·ªÉ upload file c·ª±c l·ªõn (v√†i GB) ƒë·ªÉ l√†m c·∫°n ki·ªát:

   - Disk space
   - Memory
   - Network bandwidth
   - Processing power

2. **NgƒÉn storage abuse**: User c√≥ th·ªÉ upload h√†ng ngh√¨n file nh·ªè ƒë·ªÉ chi·∫øm d·ª•ng storage

3. **B·∫£o v·ªá service availability**: ƒê·∫£m b·∫£o server kh√¥ng b·ªã qu√° t·∫£i b·ªüi upload requests

---

## üéØ Ph·∫°m vi √°p d·ª•ng

### Framework h·ªó tr·ª£:

- ‚úÖ **Node.js**: multer, express
- ‚úÖ **NestJS**: FileInterceptor, FilesInterceptor
- ‚úÖ **Java/Spring Boot**: multipart configuration
- ‚ö†Ô∏è **Python/Flask**: (Future support)
- ‚ö†Ô∏è **PHP**: (Future support)

### File types:

- `.ts`, `.js`, `.tsx`, `.jsx` (TypeScript/JavaScript)
- `.java` (Java - properties files)

---

## üö® C√°c vi ph·∫°m ph√°t hi·ªán

### 1. Multer kh√¥ng c√≥ limits (HIGH)

```javascript
// ‚ùå VIOLATION: Multer thi·∫øu gi·ªõi h·∫°n ho√†n to√†n
const upload = multer({ dest: "uploads/" });

// ‚ùå VIOLATION: Multer thi·∫øu limits object
const upload = multer({
  storage: diskStorage({ destination: "./uploads" }),
});

// ‚ùå VIOLATION: Multer c√≥ limits nh∆∞ng thi·∫øu fileSize
const upload = multer({
  limits: {
    files: 5, // Ch·ªâ gi·ªõi h·∫°n s·ªë l∆∞·ª£ng, kh√¥ng gi·ªõi h·∫°n size
  },
});
```

**Severity:** ERROR  
**Message:** "Multer configuration missing size limits - add limits.fileSize and limits.files"

---

### 2. File size limit qu√° cao (HIGH/MEDIUM)

```javascript
// ‚ùå HIGH RISK: File size > 50MB
const upload = multer({
  limits: {
    fileSize: 100 * 1024 * 1024, // 100MB - QU√Å CAO!
  },
});

// ‚ö†Ô∏è MEDIUM RISK: File size > 20MB
const upload = multer({
  limits: {
    fileSize: 30 * 1024 * 1024, // 30MB - CAO H∆†N KHUY·∫æN NGH·ªä
  },
});
```

**Severity:** ERROR (> 50MB), WARNING (> 20MB)  
**Message:** "File size limit too high (100MB) - recommend ‚â§ 10MB"

---

### 3. FileInterceptor thi·∫øu limits (HIGH)

```typescript
// ‚ùå VIOLATION: FileInterceptor kh√¥ng c√≥ limits
@Post('/upload')
@UseInterceptors(FileInterceptor('file'))
uploadFile(@UploadedFile() file: Express.Multer.File) {
  return this.fileService.save(file);
}

// ‚ùå VIOLATION: FilesInterceptor kh√¥ng c√≥ limits
@Post('/gallery')
@UseInterceptors(FilesInterceptor('images'))
uploadGallery(@UploadedFiles() files: Array<Express.Multer.File>) {
  return this.galleryService.save(files);
}
```

**Severity:** ERROR  
**Message:** "FileInterceptor missing 'limits' configuration - add { limits: { fileSize: 10485760 } }"

---

### 4. Express middleware thi·∫øu body limit (MEDIUM)

```javascript
// ‚ö†Ô∏è WARNING: express.json() kh√¥ng gi·ªõi h·∫°n
app.use(express.json());

// ‚ö†Ô∏è WARNING: express.urlencoded() kh√¥ng gi·ªõi h·∫°n
app.use(express.urlencoded({ extended: true }));
```

**Severity:** WARNING  
**Message:** "express.json() missing body size limit - add { limit: '10mb' }"

---

## ‚úÖ C√°ch s·ª≠a ƒë√∫ng

### 1. Multer v·ªõi limits h·ª£p l√Ω

```javascript
// ‚úÖ GOOD: Multer v·ªõi limits ƒë·∫ßy ƒë·ªß
const upload = multer({
  dest: "uploads/",
  limits: {
    fileSize: 10 * 1024 * 1024, // 10MB
    files: 5, // T·ªëi ƒëa 5 files
  },
});

// ‚úÖ GOOD: Multer v·ªõi fileFilter validation
const upload = multer({
  storage: diskStorage({
    destination: "./uploads",
    filename: (req, file, cb) => {
      const uniqueName = `${Date.now()}-${file.originalname}`;
      cb(null, uniqueName);
    },
  }),
  limits: {
    fileSize: 5 * 1024 * 1024, // 5MB per file
    files: 3, // Max 3 files
  },
  fileFilter: (req, file, cb) => {
    // Additional validation
    const allowedTypes = ["image/jpeg", "image/png"];
    if (allowedTypes.includes(file.mimetype)) {
      cb(null, true);
    } else {
      cb(new Error("Invalid file type"), false);
    }
  },
});
```

---

### 2. NestJS FileInterceptor v·ªõi limits

```typescript
// ‚úÖ GOOD: FileInterceptor v·ªõi limits
@Post('/avatar')
@UseInterceptors(FileInterceptor('file', {
  limits: {
    fileSize: 5 * 1024 * 1024  // 5MB
  }
}))
uploadAvatar(@UploadedFile() file: Express.Multer.File) {
  return this.userService.updateAvatar(file);
}

// ‚úÖ GOOD: FilesInterceptor v·ªõi limits
@Post('/documents')
@UseInterceptors(FilesInterceptor('documents', 10, {
  limits: {
    fileSize: 10 * 1024 * 1024,  // 10MB per file
    files: 10                     // Max 10 files (also in decorator)
  }
}))
uploadDocuments(@UploadedFiles() files: Array<Express.Multer.File>) {
  return this.documentService.save(files);
}

// ‚úÖ GOOD: FileFieldsInterceptor v·ªõi limits
@Post('/profile')
@UseInterceptors(FileFieldsInterceptor([
  { name: 'avatar', maxCount: 1 },
  { name: 'documents', maxCount: 5 }
], {
  limits: {
    fileSize: 5 * 1024 * 1024
  }
}))
updateProfile(
  @UploadedFiles() files: { avatar?: Express.Multer.File[], documents?: Express.Multer.File[] }
) {
  return this.profileService.update(files);
}
```

---

### 3. Express middleware v·ªõi body limit

```javascript
// ‚úÖ GOOD: express.json v·ªõi limit
app.use(express.json({ limit: "10mb" }));

// ‚úÖ GOOD: express.urlencoded v·ªõi limit
app.use(
  express.urlencoded({
    limit: "10mb",
    extended: true,
  })
);

// ‚úÖ GOOD: Custom limit cho specific routes
const uploadRouter = express.Router();
uploadRouter.use(express.json({ limit: "5mb" }));

uploadRouter.post("/images", upload.single("image"), (req, res) => {
  // Handle upload
});
```

---

### 4. Spring Boot configuration

```properties
# ‚úÖ GOOD: application.properties
spring.servlet.multipart.max-file-size=10MB
spring.servlet.multipart.max-request-size=20MB
spring.servlet.multipart.enabled=true
```

```yaml
# ‚úÖ GOOD: application.yml
spring:
  servlet:
    multipart:
      max-file-size: 10MB
      max-request-size: 20MB
      enabled: true
```

---

## üìä Ng∆∞·ª°ng khuy·∫øn ngh·ªã

| Lo·∫°i             | Khuy·∫øn ngh·ªã | Medium Risk | High Risk  |
| ---------------- | ----------- | ----------- | ---------- |
| **File size**    | ‚â§ 10MB      | > 20MB      | > 50MB     |
| **File count**   | ‚â§ 10 files  | > 20 files  | > 50 files |
| **Request size** | ‚â§ 20MB      | > 40MB      | > 100MB    |

### Gi·∫£i th√≠ch:

- **10MB per file**: ƒê·ªß cho h·∫ßu h·∫øt use cases (images, documents, PDFs)
- **10 files**: NgƒÉn bulk upload abuse
- **20MB total request**: Cho ph√©p multiple files nh∆∞ng kh√¥ng qu√° l·ªõn

### C√°c tr∆∞·ªùng h·ª£p ƒë·∫∑c bi·ªát:

```javascript
// Video uploads - c√≥ th·ªÉ cao h∆°n nh∆∞ng c·∫ßn validation
const videoUpload = multer({
  limits: {
    fileSize: 50 * 1024 * 1024, // 50MB for video
    files: 1, // Only 1 video
  },
  fileFilter: (req, file, cb) => {
    if (file.mimetype.startsWith("video/")) {
      cb(null, true);
    } else {
      cb(new Error("Only video files allowed"), false);
    }
  },
});

// Archive files - c·∫ßn ki·ªÉm tra content
const archiveUpload = multer({
  limits: {
    fileSize: 20 * 1024 * 1024, // 20MB for zip/tar
  },
  fileFilter: (req, file, cb) => {
    const allowedTypes = ["application/zip", "application/x-tar"];
    if (allowedTypes.includes(file.mimetype)) {
      cb(null, true);
    } else {
      cb(new Error("Only archive files allowed"), false);
    }
  },
});
```

---

## üîç Chi ti·∫øt k·ªπ thu·∫≠t

### Pattern detection:

1. **Multer initialization:**

   ```javascript
   multer({ limits: { fileSize, files } });
   ```

2. **FileInterceptor decorator:**

   ```typescript
   @UseInterceptors(FileInterceptor('field', { limits }))
   ```

3. **Express middleware:**
   ```javascript
   express.json({ limit: "10mb" });
   ```

### AST nodes checked:

- `SyntaxKind.CallExpression` - multer(), express.json()
- `SyntaxKind.Decorator` - @UseInterceptors()
- Object literals - configuration objects

### Deduplication:

Rule s·ª≠ d·ª•ng `reportedLines` Set ƒë·ªÉ tr√°nh b√°o duplicate errors tr√™n c√πng m·ªôt d√≤ng.

---

## üéØ Best Practices

### 1. Layered defense

```typescript
// ‚úÖ Multiple layers of protection
@Post('/upload')
@UseGuards(AuthGuard)  // 1. Authentication
@UseInterceptors(FileInterceptor('file', {
  limits: {
    fileSize: 10 * 1024 * 1024  // 2. Size limit
  },
  fileFilter: (req, file, cb) => {
    // 3. Type validation
    const allowedTypes = ['image/jpeg', 'image/png'];
    if (!allowedTypes.includes(file.mimetype)) {
      return cb(new Error('Invalid file type'), false);
    }
    cb(null, true);
  }
}))
async uploadFile(
  @UploadedFile() file: Express.Multer.File,
  @Req() req
) {
  // 4. Additional server-side validation
  if (!file) {
    throw new BadRequestException('No file uploaded');
  }

  // 5. Magic number validation
  const isValid = await this.fileService.validateFileContent(file);
  if (!isValid) {
    await this.fileService.deleteFile(file.path);
    throw new BadRequestException('Invalid file content');
  }

  // 6. User quota check
  const userStorage = await this.userService.getStorageUsage(req.user.id);
  if (userStorage + file.size > USER_STORAGE_QUOTA) {
    await this.fileService.deleteFile(file.path);
    throw new BadRequestException('Storage quota exceeded');
  }

  return this.fileService.save(file, req.user.id);
}
```

---

### 2. Logging and monitoring

```typescript
// ‚úÖ Log upload attempts and rejections
@Post('/upload')
@UseInterceptors(FileInterceptor('file', {
  limits: { fileSize: 10 * 1024 * 1024 }
}))
async uploadFile(@UploadedFile() file, @Req() req) {
  try {
    this.logger.log({
      event: 'file_upload_attempt',
      userId: req.user.id,
      filename: file.originalname,
      size: file.size,
      mimetype: file.mimetype,
      ip: req.ip
    });

    const result = await this.fileService.save(file);

    this.logger.log({
      event: 'file_upload_success',
      userId: req.user.id,
      fileId: result.id
    });

    return result;
  } catch (error) {
    this.logger.error({
      event: 'file_upload_failed',
      userId: req.user.id,
      filename: file?.originalname,
      size: file?.size,
      error: error.message,
      ip: req.ip
    });
    throw error;
  }
}
```

---

### 3. Rate limiting

```typescript
// ‚úÖ Combine with rate limiting
import { Throttle } from "@nestjs/throttler";

@Controller("upload")
export class UploadController {
  @Post("/avatar")
  @Throttle(5, 60) // Max 5 uploads per 60 seconds
  @UseInterceptors(
    FileInterceptor("file", {
      limits: { fileSize: 5 * 1024 * 1024 },
    })
  )
  uploadAvatar(@UploadedFile() file) {
    return this.userService.updateAvatar(file);
  }
}
```

---

## üîó Li√™n quan

### Rules li√™n quan:

- **S025** - Server-side Validation: Validate file type, content
- **S055** - Content-Type Validation: Validate Content-Type header

### OWASP Top 10:

- **A04:2021** - Insecure Design
- **A05:2021** - Security Misconfiguration

### CWE:

- **CWE-400** - Uncontrolled Resource Consumption
- **CWE-770** - Allocation of Resources Without Limits or Throttling

---

## üìö T√†i li·ªáu tham kh·∫£o

1. **OWASP File Upload Cheat Sheet**  
   https://cheatsheetseries.owasp.org/cheatsheets/File_Upload_Cheat_Sheet.html

2. **Multer Documentation**  
   https://github.com/expressjs/multer

3. **NestJS File Upload**  
   https://docs.nestjs.com/techniques/file-upload

4. **CWE-400: Uncontrolled Resource Consumption**  
   https://cwe.mitre.org/data/definitions/400.html

---

## üöÄ Testing

### Test v·ªõi SunLint:

```bash
# Test rule tr√™n m·ªôt file
node cli.js --rule=S028 --input=src/upload/upload.controller.ts --engine=heuristic

# Test tr√™n to√†n b·ªô project
node cli.js --rule=S028 --input=src --engine=heuristic

# Test v·ªõi verbose output
SUNLINT_DEBUG=1 node cli.js --rule=S028 --input=src --engine=heuristic
```

### Expected violations:

- ‚ùå Multer thi·∫øu limits
- ‚ùå FileInterceptor thi·∫øu limits
- ‚ö†Ô∏è Express middleware thi·∫øu limit
- ‚ùå File size > 50MB (high risk)
- ‚ö†Ô∏è File size > 20MB (medium risk)

---

## ‚ú® Version History

- **v1.0** (2025-01-23): Initial release
  - Support Node.js/NestJS file upload detection
  - Multer configuration checking
  - FileInterceptor validation
  - Express middleware checking
  - Threshold validation (10MB/20MB/50MB)
