## Rule C042
**Title:** Require re-authentication for long-lived sessions or sensitive actions

---

### Objective
Reduce the risk of session hijacking or privilege misuse by forcing re-authentication after long idle periods or before critical actions.

### Details
- **Persistent Login or "Remember Me":**
  - Require re-login after X hours (e.g., 12h, 24h)
  - Re-authenticate after inactivity (e.g., 30 mins)
  - Require password or 2FA for sensitive actions (password change, payments)
- **For JWT:**
  - Use short-lived tokens with secure refresh logic
- **Best Practice:**
  - Do not flag as a violation if re-authentication logic exists in downstream service/common methods even when the immediate controller/service does not show it directly.

### Applies to
- All programming languages
- Critical for backend/auth REST API development

### Detection
- Detect session configs with excessive lifetime (e.g., session maxAge > 24h, JWT expiresIn > 1h for access tokens)
- Detect missing re-authentication check on sensitive actions (by function name or endpoint path)
- Should NOT flag data objects (e.g., session DB records with expiresAt)
- Should follow method call chains to detect delegated re-authentication (service/deep method etc.)

### Tools/Validation
- Manual code review
- Static analysis (for JWT expiry, session policy)
- Security functional tests
- SonarQube (custom rule integration)

---

### Example: Clean vs Violation

#### Clean (no violation)
```typescript
async changePassword(userId: string, currentPassword: string, newPassword: string) {
  // Re-authentication logic via password verification
  const user = await this.userRepository.findById(userId);
  if (!await bcrypt.compare(currentPassword, user.passwordHash)) {
    throw new UnauthorizedException();
  }
  // ...
}
```

#### Violation (should be flagged)
```typescript
async changePassword(userId: string, newPassword: string) {
  // No password verification
  await this.userRepository.updatePassword(userId, newPassword);
}
```

#### Violation (configuration)
```js
app.use(session({ cookie: { maxAge: 90 * 24 * 60 * 60 * 1000 } })); // 90 days
```

---

### Resources
- [OWASP Session Management Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Session_Management_Cheat_Sheet.html)
- [JWT Best Practices](https://auth0.com/blog/jwt-best-practices/)

### Severity
Medium

### Status
Activated

### Version
1.0

---

### Labels
- Security Custom Rules
- documentation
