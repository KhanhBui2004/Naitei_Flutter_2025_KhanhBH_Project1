# S044: Re-authentication Required for Sensitive Operations

## Mô tả
Rule này yêu cầu xác thực lại trước khi thực hiện các thao tác nhạy cảm như thay đổi mật khẩu, email, thông tin profile và các thao tác quan trọng khác. Điều này ngăn chặn việc truy cập trái phép vào các chức năng tài khoản nhạy cảm ngay cả khi session bị xâm phạm.

## Tại sao cần thiết?
- **Bảo mật tài khoản**: Ngăn chặn kẻ tấn công thay đổi thông tin quan trọng ngay cả khi có session
- **Tuân thủ OWASP**: Theo khuyến nghị của OWASP về authentication security
- **Bảo vệ dữ liệu người dùng**: Đảm bảo chỉ chủ tài khoản mới có thể thay đổi thông tin nhạy cảm

## Các thao tác nhạy cảm được detect
- `changePassword`, `updatePassword`, `resetPassword`
- `changeEmail`, `updateEmail`
- `changeProfile`, `updateProfile`
- `deleteAccount`, `deactivateAccount`
- `changePhoneNumber`, `updatePhoneNumber`
- `changeSecurityQuestion`, `updateSecurityQuestion`
- `changeTwoFactorSettings`, `updateTwoFactorSettings`
- `changeBillingInfo`, `updateBillingInfo`
- `changePaymentMethod`, `updatePaymentMethod`

## Cách sử dụng

### NestJS với Decorators
```typescript
@Controller('user')
export class UserController {
  // ✅ Đúng: Có re-authentication guard
  @Post('change-password')
  @UseGuards(ReAuthGuard)
  async changePassword(@Body() dto: ChangePasswordDto) {
    return this.userService.changePassword(dto);
  }

  // ❌ Sai: Không có re-authentication
  @Post('change-password')
  async changePassword(@Body() dto: ChangePasswordDto) {
    return this.userService.changePassword(dto);
  }
}
```

### Express với Middleware
```typescript
// ✅ Đúng: Có re-authentication middleware
app.put('/change-password', requireReAuth, (req, res) => {
  return userService.changePassword(req.body);
});

// ❌ Sai: Không có re-authentication middleware
app.put('/change-password', (req, res) => {
  return userService.changePassword(req.body);
});
```

### Method với Re-authentication Call
```typescript
@Controller('user')
export class UserController {
  // ✅ Đúng: Gọi re-authentication trong method
  @Post('change-password')
  async changePassword(@Body() dto: ChangePasswordDto) {
    await this.userService.verifyCurrentPassword(dto.currentPassword);
    return this.userService.changePassword(dto);
  }
}
```

## Các pattern re-authentication được hỗ trợ

### NestJS Decorators
- `@UseGuards(ReAuthGuard)`
- `@UseGuards(ReAuthenticationGuard)`
- `@UseGuards(VerifyReAuthGuard)`

### Express Middleware
- `requireReAuth`
- `requireReAuthentication`
- `verifyReAuth`
- `checkReAuth`
- `validateReAuth`

### Re-authentication Methods
- `verifyPassword`
- `confirmPassword`
- `reAuthenticate`
- `verifyCurrentPassword`
- `validatePassword`
- `checkPassword`
- `authenticateUser`
- `verifyIdentity`

## Cấu hình

Rule này hỗ trợ cấu hình trong `config.json`:

```json
{
  "configuration": {
    "enableReAuthenticationDetection": true,
    "sensitiveOperations": [...],
    "authenticationMethods": [...],
    "middlewarePatterns": [...],
    "frameworkSpecific": {
      "express": {...},
      "nestjs": {...}
    }
  }
}
```

## Test Cases

Rule được test với các test cases sau:

### Violations (6 cases)
- `password_change_without_reauth.ts` - Thay đổi mật khẩu không có re-auth
- `email_change_without_reauth.ts` - Thay đổi email không có re-auth  
- `profile_update_without_reauth.ts` - Cập nhật profile không có re-auth
- `express_routes_without_reauth.ts` - Express routes không có middleware

### Clean (4 cases)
- `password_change_with_reauth.ts` - Có @UseGuards decorator
- `email_change_with_reauth.ts` - Có @UseGuards decorator
- `profile_update_with_reauth.ts` - Có @UseGuards decorator
- `express_routes_with_reauth.ts` - Có middleware
- `method_with_reauth_call.ts` - Có re-auth method call

## Kết quả test
- **Total violations**: 6 (chỉ từ files violations)
- **Clean files**: 0 violations (đã được bảo vệ đúng cách)
- **Accuracy**: 100% - Rule chỉ detect các thao tác thực sự thiếu re-authentication

## Tài liệu tham khảo
- [OWASP Authentication Cheat Sheet](https://owasp.org/www-community/controls/Authentication_Cheat_Sheet)
- [OWASP Session Management Cheat Sheet](https://owasp.org/www-community/attacks/Session_Management_Cheat_Sheet)
