# S038 - Do Not Expose Version Information in Response Headers

## Overview

Rule S038 prevents the exposure of server and framework version information through HTTP response headers. This reduces information disclosure that could help attackers identify known vulnerabilities in specific versions of web servers, frameworks, or runtime environments.

Common version-revealing headers include:

- `Server: nginx/1.18.0`
- `X-Powered-By: Express`
- `X-AspNet-Version: 4.0.30319`
- `X-Generator: Drupal 7`

## Framework Support

This rule supports multiple web frameworks:

- **Express.js**: Route handlers using `app.get()`, `router.post()`, etc.
- **Next.js**: API routes (`export default function handler`) and App Router (`export async function GET`)
- **NestJS**: Controller methods with decorators (`@Get()`, `@Post()`, etc.)
- **Nuxt.js**: Server routes (`export default defineEventHandler`)

## Security Impact

Version information disclosure can:

- Help attackers identify known vulnerabilities in specific versions
- Facilitate targeted attacks against outdated software
- Provide reconnaissance information for further attacks
- Violate security best practices for information hiding

## Rule Details

### Prohibited Headers

The following headers should not expose version information:

- `Server`
- `X-Powered-By`
- `X-AspNet-Version`
- `X-AspNetMvc-Version`
- `X-Generator`
- `X-Runtime`
- `X-Version`
- `X-Framework`
- `X-Drupal-Cache`
- `X-Varnish`
- `X-Cache`
- `X-Served-By`

### Version Information Patterns

The rule detects these patterns in header values:

- Version numbers: `1.0`, `2.1.3`, `v1.2`
- Framework names: `Express`, `nginx`, `Apache`, `IIS`
- Runtime versions: `Node.js`, `PHP`, `ASP.NET`

## Violations

### Express.js Examples

```typescript
// ❌ Violation: Exposing server version
app.get("/api/data", (req, res) => {
  res.setHeader("Server", "nginx/1.18.0");
  res.setHeader("X-Powered-By", "Express 4.18.0");
  res.json({ data: "value" });
});

// ❌ Violation: Custom version header
app.get("/api/info", (req, res) => {
  res.set("X-Version", "MyApp v2.1.3");
  res.json({ status: "ok" });
});
```

### NestJS Examples

```typescript
// ❌ Violation: Framework version disclosure
@Get('status')
getStatus(@Res() res: Response) {
  res.header('X-Powered-By', 'NestJS 9.0.0');
  res.header('X-Framework', 'Node.js/Express');
  return res.json({ status: 'running' });
}
```

### Next.js Examples

```typescript
// ❌ Violation: Runtime version exposure
export default function handler(req, res) {
  res.setHeader("X-Runtime", "Node.js 18.16.0");
  res.setHeader("Server", "Vercel");
  res.json({ message: "Hello" });
}
```

## Compliant Code

### Express.js Solutions

```typescript
// ✅ Correct: Remove or hide version headers
app.disable("x-powered-by"); // Remove Express header

app.get("/api/data", (req, res) => {
  // No version headers set
  res.json({ data: "value" });
});

// ✅ Correct: Use helmet middleware
const helmet = require("helmet");
app.use(helmet.hidePoweredBy());

// ✅ Correct: Generic server header
app.get("/api/secure", (req, res) => {
  res.setHeader("Server", "WebServer"); // Generic, no version
  res.json({ data: "secure" });
});
```

### NestJS Solutions

```typescript
// ✅ Correct: Use helmet middleware
import helmet from "helmet";

@Controller()
export class AppController {
  constructor() {
    // Configure helmet in main.ts
  }

  @Get("status")
  getStatus() {
    // No version headers
    return { status: "running" };
  }
}

// In main.ts:
app.use(
  helmet({
    hidePoweredBy: true,
  })
);
```

### Next.js Solutions

```typescript
// ✅ Correct: No version headers
export default function handler(req, res) {
  res.json({ message: "Hello" });
}

// ✅ Correct: Configure in next.config.js
module.exports = {
  async headers() {
    return [
      {
        source: "/(.*)",
        headers: [
          {
            key: "Server",
            value: "WebServer", // Generic server name
          },
        ],
      },
    ];
  },
};
```

## Configuration Solutions

### nginx Configuration

```nginx
# Hide nginx version
server_tokens off;

# Remove specific headers
more_clear_headers 'Server';
more_clear_headers 'X-Powered-By';
```

### Apache Configuration

```apache
# Hide Apache version
ServerTokens Prod
ServerSignature Off

# Remove specific headers
Header unset Server
Header unset X-Powered-By
```

## Best Practices

1. **Use Security Middleware**: Implement helmet.js or similar security middleware
2. **Server Configuration**: Configure web servers to hide version information
3. **Regular Audits**: Regularly check response headers for version leaks
4. **Generic Headers**: Use generic server names instead of specific versions
5. **Reverse Proxy**: Use a reverse proxy to normalize all outgoing headers

## Exceptions

This rule may not apply when:

- Version information is intentionally exposed for debugging (development only)
- API versioning requires version headers (use API version, not server version)
- Third-party services require specific version headers

## Related Rules

- **S055**: Content-Type Validation
- **S031**: Secure Session Cookies
- **S037**: Cache Headers for Sensitive Data

## Implementation Notes

The rule uses both symbol-based (AST) and regex-based analysis to detect:

1. Direct header setting in route handlers
2. Bulk header object assignments
3. Framework-specific header methods
4. Version patterns in header values

Security middleware detection automatically skips analysis when proper security measures are in place.
